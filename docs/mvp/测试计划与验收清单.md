# 测试计划与验收清单

## 1. 单元测试
目标模块：
- `NameResolver`：`my name is / i am / i'm` 规则识别
- `OnlineClusterer`：新 cluster 创建与已有 cluster 更新
- `BinderPolicy`：low/mid/high 三档阈值决策

运行：
```bash
cd /Users/billthechurch/Interview-feedback/inference
pytest -q
```

## 2. 集成测试
### 2.1 健康检查
```bash
curl -s http://localhost:8000/health | jq
```

### 2.2 embedding 提取
调用 `/sv/extract_embedding`，确认返回非空向量和 embedding_dim。

### 2.3 score 对比
同人分数必须显著高于异人分数。

### 2.4 resolve 决策
`/speaker/resolve` 必须返回：
- `cluster_id`
- `decision` in `auto|confirm|unknown`
- `evidence`（含阈值、score、name_hit）
- `updated_state`

## 3. Smoke 回归
准备样例：
- `samples/alice_enroll.wav`
- `samples/alice_probe.wav`
- `samples/bob_enroll.wav`
- `samples/bob_probe.wav`

执行：
```bash
 /Users/billthechurch/Interview-feedback/scripts/validate_samples.sh \
  /Users/billthechurch/Interview-feedback/samples

python /Users/billthechurch/Interview-feedback/scripts/smoke_sv.py \
  --base-url http://localhost:8000 \
  --samples /Users/billthechurch/Interview-feedback/samples
```

通过标准：
- 脚本退出码 0
- Alice 与 Bob 各自 Top-1 命中
- 至少一次 resolve 返回 `auto` 或 `confirm`

## 4. 非功能验收
- 容器重建后模型缓存仍复用。
- Cloudflare Tunnel 地址可访问 `/health` 与 `/speaker/resolve`。
- 错误码行为符合 400/401/413/422/429/500/501 约定。
- 限流头可观测：`X-RateLimit-Limit`、`X-RateLimit-Remaining`、`X-RateLimit-Reset`。
