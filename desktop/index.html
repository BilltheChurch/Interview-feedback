<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Interview Feedback Desktop</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <main id="app-root" class="app-root mode-dashboard">
      <section id="dashboard-view" class="dashboard-view">
        <header class="dash-hero panel">
          <div>
            <h1>Interview Companion</h1>
            <p class="subtitle">Plan meetings first. The memo sidebar auto-attaches when Teams is detected.</p>
          </div>
          <div class="chip-row">
            <span class="chip" id="app-info">Loading runtime info...</span>
            <span class="chip chip-info" id="attach-status">Attach: searching</span>
            <span class="chip chip-neutral" id="backend-badge">Backend: cloud</span>
            <span class="chip chip-accent" id="recording-timer">00:00</span>
          </div>
        </header>

        <section class="dash-grid">
          <article class="panel">
            <div class="panel-header">
              <h2>Meeting Dashboard</h2>
              <span class="muted small">Manual add or Microsoft Graph sync</span>
            </div>

            <div class="field-grid">
              <label class="field compact">
                <span>Session ID</span>
                <input id="meeting-id" type="text" value="local-selfcheck" />
              </label>
              <label class="field compact">
                <span>Gateway HTTP URL</span>
                <input id="api-base-url" type="text" value="https://api.frontierace.ai" />
              </label>
              <label class="field compact">
                <span>Diarization Backend</span>
                <select id="diarization-backend">
                  <option value="cloud">cloud</option>
                  <option value="edge">edge (pyannote-rs sidecar)</option>
                </select>
              </label>
            </div>

            <div class="field-grid field-grid-2">
              <label class="field compact">
                <span>Interviewer Name</span>
                <input id="interviewer-name" type="text" placeholder="e.g. Bill" />
              </label>
              <label class="field compact">
                <span>Teams Interviewer Name</span>
                <input id="teams-interviewer-name" type="text" placeholder="Optional" />
              </label>
            </div>

            <label class="field compact">
              <span>Meeting Title</span>
              <input id="dashboard-meeting-title" type="text" placeholder="Case Interview Mock #12" />
            </label>

            <div class="field-grid field-grid-2">
              <label class="field compact">
                <span>Start At (local)</span>
                <input id="dashboard-meeting-start" type="datetime-local" />
              </label>
              <label class="field compact">
                <span>Meeting Join URL</span>
                <input id="dashboard-meeting-url" type="url" placeholder="https://teams.microsoft.com/l/meetup-join/..." />
              </label>
            </div>

            <label class="field compact">
              <span>Participants (one per line)</span>
              <textarea id="dashboard-meeting-participants" rows="5" placeholder="Alice\nBob\nCharlie"></textarea>
            </label>

            <div class="actions wrap">
              <button id="btn-dashboard-add-meeting" type="button">Add Meeting</button>
              <button id="btn-dashboard-enter-session" type="button" class="primary">Open Sidebar Workspace</button>
            </div>

            <div id="dashboard-meeting-list" class="meeting-list">
              <p class="muted">No meetings yet. Add one manually or sync from Graph.</p>
            </div>
          </article>

          <article class="panel">
            <div class="panel-header">
              <h2>Microsoft Graph (Teams Calendar)</h2>
              <span class="muted small">Real Graph flow with device-code auth</span>
            </div>

            <div class="field-grid field-grid-2">
              <label class="field compact">
                <span>Azure App Client ID</span>
                <input id="graph-client-id" type="text" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
              </label>
              <label class="field compact">
                <span>Tenant ID</span>
                <input id="graph-tenant-id" type="text" placeholder="common" value="common" />
              </label>
            </div>

            <div class="actions wrap">
              <button id="btn-graph-save-config" type="button">Save Graph Config</button>
              <button id="btn-graph-connect" type="button">Connect Microsoft</button>
              <button id="btn-graph-sync" type="button">Sync Upcoming Meetings</button>
              <button id="btn-graph-create-meeting" type="button">Create Group Meeting</button>
              <button id="btn-graph-disconnect" type="button">Disconnect</button>
            </div>

            <pre id="graph-status" class="status-box">Graph not configured.</pre>

            <div class="panel-header top-gap">
              <h2>Attach Controller</h2>
              <span class="muted small">Sidebar appears when Teams is found</span>
            </div>
            <div class="actions wrap">
              <button id="btn-attach-teams" type="button">Attach to Teams</button>
              <button id="btn-detach-teams" type="button">Detach</button>
              <button id="btn-open-accessibility-settings" type="button">Open Accessibility Settings</button>
              <button id="btn-open-automation-settings" type="button">Open Automation Settings</button>
            </div>
            <p id="attach-hint" class="muted">If permission is required, grant access then restart the app once.</p>
            <p id="upload-status" class="muted">Upload not started.</p>
          </article>
        </section>
      </section>

      <section id="session-view" class="session-view hidden">
        <header class="session-top panel">
          <div class="panel-header">
            <div>
              <h2>Live Memo Sidebar</h2>
              <p class="muted small">Attached workflow during active Teams meeting</p>
            </div>
            <div class="actions compact">
              <button id="btn-ui-density" type="button">Density: Comfort</button>
              <button id="btn-back-dashboard" type="button">Dashboard</button>
              <button id="btn-save-session-config" type="button">Save Config</button>
            </div>
          </div>

          <div class="actions wrap">
            <button id="btn-init-mic" type="button">Init Mic</button>
            <button id="btn-init-system" type="button">Init System Audio</button>
            <button id="btn-start-upload" type="button" disabled>Start Session</button>
            <button id="btn-stop-upload" type="button" disabled>Stop Session</button>
            <button id="btn-fetch-upload-status" type="button" disabled>Fetch Status</button>
          </div>
        </header>

        <section class="session-stack">
          <section class="panel flow-panel">
            <div class="panel-header">
              <h2>Flow</h2>
              <span class="muted small">Question progress + instant feedback access</span>
            </div>
            <div class="flow-grid">
              <div class="flow-card">
                <strong>Question Stage</strong>
                <div id="flow-stage-label" class="muted">Q1 in progress</div>
              </div>
              <div class="flow-card">
                <strong>Session Timer</strong>
                <div id="flow-session-timer" class="muted">00:00</div>
              </div>
              <div class="flow-card">
                <strong>Feedback SLA</strong>
                <div id="flow-feedback-sla" class="muted">Target: <= 3s full report</div>
              </div>
            </div>
            <div class="actions wrap">
              <button id="btn-feedback-ready" type="button">Check Feedback Ready</button>
              <button id="btn-open-feedback" type="button" class="primary">Open Feedback (<=3s)</button>
            </div>
          </section>

          <section class="panel memo-panel">
            <div class="panel-header">
              <h2>Notes &amp; Marks</h2>
              <span class="muted small">Structured notes become report evidence.</span>
            </div>
            <div class="field-grid field-grid-2">
              <label class="field compact">
                <span>Type</span>
                <select id="memo-type">
                  <option value="observation">observation</option>
                  <option value="evidence">evidence</option>
                  <option value="question">question</option>
                  <option value="decision">decision</option>
                  <option value="score">score</option>
                </select>
              </label>
              <label class="field compact">
                <span>Tags (comma separated)</span>
                <input id="memo-tags" type="text" placeholder="leadership,collaboration" />
              </label>
            </div>
            <label class="field">
              <span>Memo</span>
              <textarea id="memo-text" rows="3" placeholder="Type memo and press Add Memo"></textarea>
            </label>
            <div class="actions">
              <button id="btn-memo-add" type="button">Add Memo</button>
              <button id="btn-memo-anchor-last" type="button">Anchor Last Utterance</button>
            </div>
            <pre id="memo-list" class="result-box memo-list">No memos yet.</pre>
          </section>

          <section class="panel signal-panel">
            <div class="panel-header">
              <h2>Signals</h2>
              <span class="muted small">Waveform / health / quick checks</span>
            </div>
            <p id="capture-health" class="muted">Capture health initializing...</p>
            <div class="meter-grid">
              <div class="meter-wrap">
                <div class="meter-label">Mic</div>
                <div class="meter-track"><div id="meter-mic-bar" class="meter-bar"></div></div>
                <div id="meter-mic-value" class="meter-value">0%</div>
              </div>
              <div class="meter-wrap">
                <div class="meter-label">System</div>
                <div class="meter-track"><div id="meter-system-bar" class="meter-bar"></div></div>
                <div id="meter-system-value" class="meter-value">0%</div>
              </div>
              <div class="meter-wrap">
                <div class="meter-label">Mixed</div>
                <div class="meter-track"><div id="meter-mixed-bar" class="meter-bar"></div></div>
                <div id="meter-mixed-value" class="meter-value">0%</div>
              </div>
            </div>
            <div class="actions wrap">
              <button id="btn-start-recording" type="button" disabled>Start 30s Recording</button>
              <button id="btn-stop-recording" type="button" disabled>Stop Recording</button>
              <button id="btn-open-last-file" type="button" disabled>Open Last WAV</button>
            </div>
            <audio id="playback" controls></audio>
          </section>

          <section class="panel participant-panel">
            <div class="panel-header">
              <h2>Enrollment</h2>
              <span class="muted small">Speaker mapping + participation</span>
            </div>

            <div class="field participants-field">
              <span>Participants</span>
              <div id="participant-list" class="participant-list"></div>
              <div class="actions wrap">
                <button id="btn-participant-add" type="button">Add Participant</button>
                <button id="btn-participant-import" type="button">Import Names</button>
                <button id="btn-enrollment-start" type="button">Start Enrollment</button>
                <button id="btn-enrollment-stop" type="button">Stop Enrollment</button>
              </div>
            </div>

            <div id="participant-live-list" class="participant-live-list">
              <p class="muted">No participant metrics yet.</p>
            </div>
            <pre id="enrollment-status" class="result-box compact">Enrollment idle.</pre>
          </section>
        </section>

        <footer class="bottom-strip panel">
          <div class="actions wrap">
            <button id="btn-finalize-v2" type="button">Finalize V2 (Background)</button>
            <button id="btn-feedback-export-text" type="button">Copy Plain Text</button>
            <button id="btn-feedback-export-md" type="button">Export Markdown</button>
            <button id="btn-feedback-export-docx" type="button">Export DOCX</button>
            <button id="btn-open-review" type="button">Review</button>
            <button id="btn-toggle-debug" type="button">Debug</button>
            <button id="btn-refresh-live" type="button">Refresh Live View</button>
          </div>
          <pre id="finalize-v2-status" class="status-box">Idle.</pre>
          <ul id="finalize-stage-list" class="stage-list" aria-label="Finalize Progress">
            <li data-finalize-stage="queued">queued</li>
            <li data-finalize-stage="freeze">freeze</li>
            <li data-finalize-stage="drain">drain</li>
            <li data-finalize-stage="replay_gap">replay_gap</li>
            <li data-finalize-stage="aggregate">aggregate</li>
            <li data-finalize-stage="analysis_events">analysis_events</li>
            <li data-finalize-stage="analysis_report">analysis_report</li>
            <li data-finalize-stage="persist">persist</li>
          </ul>
        </footer>

        <section id="review-panel" class="panel review-panel hidden">
          <div class="panel-header">
            <h2>Review</h2>
            <div class="actions compact">
              <button id="btn-review-tab-overall" type="button" class="tab-active">Overall</button>
              <button id="btn-review-tab-person" type="button">Per Person</button>
              <button id="btn-review-tab-evidence" type="button">Evidence</button>
            </div>
          </div>
          <div id="review-overall" class="review-tab"></div>
          <div id="review-per-person" class="review-tab hidden"></div>
          <div id="review-evidence" class="review-tab hidden"></div>
          <pre id="report-v2" class="result-box hidden">No report yet.</pre>
        </section>

        <section id="evidence-modal" class="evidence-modal hidden" aria-hidden="true">
          <div class="evidence-modal-backdrop" id="evidence-modal-close"></div>
          <article class="evidence-modal-card panel">
            <div class="panel-header">
              <h2>Evidence Detail</h2>
              <button id="btn-evidence-modal-close" type="button">Close</button>
            </div>
            <pre id="evidence-modal-content" class="status-box">No evidence selected.</pre>
            <div class="actions wrap">
              <button id="btn-regenerate-claim" type="button">Regenerate Claim</button>
            </div>
          </article>
        </section>

        <section id="debug-drawer" class="panel debug-drawer">
          <div class="panel-header">
            <h2>Debug</h2>
            <span class="muted small">Collapsed by default; open only for diagnostics.</span>
          </div>
          <div class="debug-tabs">
            <button type="button" data-debug-tab-btn="logs" class="tab-active">Logs</button>
            <button type="button" data-debug-tab-btn="transcript">Transcript</button>
            <button type="button" data-debug-tab-btn="events">Speaker Events</button>
            <button type="button" data-debug-tab-btn="state">State Snapshot</button>
            <button type="button" data-debug-tab-btn="tools">Tools</button>
          </div>

          <section id="debug-tab-logs" class="debug-tab-pane">
            <pre id="logs" class="logs">No logs yet.</pre>
          </section>

          <section id="debug-tab-transcript" class="debug-tab-pane hidden">
            <pre id="live-transcript" class="result-box">No transcript yet.</pre>
          </section>

          <section id="debug-tab-events" class="debug-tab-pane hidden">
            <pre id="speaker-events" class="result-box">No events yet.</pre>
          </section>

          <section id="debug-tab-state" class="debug-tab-pane hidden">
            <pre id="result-json" class="result-box">No state yet.</pre>
          </section>

          <section id="debug-tab-tools" class="debug-tab-pane hidden">
            <details class="advanced-box" open>
              <summary>Connection &amp; Sidecar</summary>
              <label class="field compact">
                <span>Gateway WS URL</span>
                <input id="ws-url" type="text" value="wss://api.frontierace.ai/v1/audio/ws" />
              </label>
              <div class="actions wrap">
                <button id="btn-sidecar-start" type="button">Start Sidecar</button>
                <button id="btn-sidecar-stop" type="button">Stop Sidecar</button>
              </div>
              <pre id="sidecar-status" class="result-box compact">Sidecar stopped.</pre>
            </details>

            <details class="advanced-box">
              <summary>Mic Processing</summary>
              <div class="field">
                <label class="switch-line"><input id="mic-aec" type="checkbox" checked /> Echo Cancellation (AEC)</label>
                <label class="switch-line"><input id="mic-ns" type="checkbox" checked /> Noise Suppression</label>
                <label class="switch-line"><input id="mic-agc" type="checkbox" /> Auto Gain Control</label>
              </div>
            </details>

            <details class="advanced-box">
              <summary>File Normalization</summary>
              <div class="actions wrap">
                <button id="btn-pick-file" type="button">Pick File</button>
                <button id="btn-normalize-file" type="button" disabled>Normalize Selected File</button>
              </div>
              <p id="selected-file" class="muted">No file selected.</p>
            </details>

            <details class="advanced-box">
              <summary>Cluster Mapping</summary>
              <div class="actions wrap">
                <button id="btn-refresh-clusters" type="button">Refresh Unresolved Clusters</button>
              </div>
              <div id="cluster-map-list" class="cluster-map-list"></div>
            </details>
          </section>
        </section>
      </section>
    </main>

    <script src="./lib/transcriptFormatter.js"></script>
    <script src="./lib/liveMetrics.js"></script>
    <script src="./renderer.js"></script>
  </body>
</html>
